{% extends 'main.html' %}

{% block title %}Dashboard | SloopStash CRM{% endblock %}

{% block content %}
<div class="row">
  <div class="col s3 m3 l3">
    <ul class="tab z-depth-1" id="main-menu">
      <li class="tab-item">
        <a class="tab-link" href="#contacts">
          <span class="fa-stack purple-text text-purple">
            <i class="fa-regular fa-square fa-stack-2x"></i>
            <i class="fa-regular fa-address-book fa-stack-1x"></i>
          </span>
        </a>
        <p><small>Contacts</small></p>
      </li>
    </ul>
  </div>
  <div class="col s18 m18 l18">
    <div class="block tab-content" id="contacts">
      <div class="block-header clearfix valign-wrapper">
        <div class="block-title left">
          <h2>
            <span class="fa-stack purple-text text-purple fa-xs">
              <i class="fa-regular fa-square fa-stack-2x"></i>
              <i class="fa-regular fa-address-book fa-stack-1x"></i>
            </span> Contacts for {{ var.customer.name }}
          </h2>
        </div>
        <div class="block-menu right">
          <a class="btn-small green darken-1 right" href="/customer/{{ var.customer.id }}/contact/create">Create contact</a>
        </div>
      </div>     
       <div class="block-content"></div>
       
      
        
        <!-- Contact List Table from list.html -->
        <div id="contacts-list">
         <table class="highlight responsive-table">
           <thead>
             <tr>
               <th>FirstName</th>
               <th>LastName</th>
               <th>Email</th>
               <th>Phonenumber</th>
               <th>Description</th>
               <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for contact in var.contacts %}
            <tr>
              <td>{{ contact.firstname }}</td>
              <td>{{ contact.lastname }}</td>
              <td>{{ contact.email }}</td>
              <td>{{ contact.phonenumber }}</td>
              <td>{{ contact.description }}</td>
              <td>
                <div class="action-buttons">
                  <a href="/customer/{{ var.customer.id }}/contact/{{ contact.id }}/update" class="edit-button">
                    <i class="fa-solid fa-pen-clip icon"></i>
                  </a>
                  <form action="/customer/{{ var.customer.id }}/contact/{{ contact.id }}/delete" method="POST">
                  <input type="hidden" name="_method" value="DELETE">
                  <button type="submit" class="delete-button">
                  <i class="fa-solid fa-trash-can icon"></i>
                  </button>
                  </form>
                </div>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="5" class="center">No contacts found for this customer.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    <div class="block-footer">
      <div class="block-action right"></div>
       </div>
     </div>
   </div>
  <div class="col s3 m3 l3"></div>
</div>
{% endblock %}

{% block js %}
<script type="text/javascript">
  $(document).ready(function() {
    var main_menu = new app.tab({
      'container':'#main-menu',
      'default':'contacts',
      'items':[
        {
          'identifier':'#contacts',
          'pager':{
            'name':'contacts',
            'mode':'normal',
            'entity':'contact',
            'url':'/customer/{{ var.customer.id }}/dashboard',
            'query':null,
            'container':'#contacts-list'
          }
        }
      ]
    });


    $(document).on('click', '.delete-contact', function() {
      var contactId = $(this).data('id');  
      if (confirm('Are you sure you want to delete this contact?')) {
        deleteContact(contactId);
      }
    });

    function deleteContact(contactId) {
      $.ajax({
        type: "POST",
        url: "/customer/{{ var.customer.id }}/contact/" + contactId + "/delete",
        data: {
          _method: 'DELETE' 
        },
        dataType: 'json',
        success: function(response) {
          if (response.status === "success") {
            alert(response.message); 
            if (response.refresh) {
              location.reload();  
            } else {
              $('#contact_' + contactId).remove();  
            }
          } else {
            alert(response.message);  
          }
        },
        error: function(xhr, status, error) {
          alert("An error occurred while deleting the contact.");
        }
      });
    }
  });
</script>
{% endblock %}
